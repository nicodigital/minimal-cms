!function(){"use strict";var e=[,function(e,t,i){i.r(t),i.d(t,{ThemeManager:function(){return n}});const n={htmlElement:null,themeToggle:null,moonIcon:null,sunIcon:null,initTheme:function(){const e=document.documentElement,t=localStorage.getItem("theme");"dark"===t||!t&&window.matchMedia("(prefers-color-scheme: dark)").matches?e.classList.add("dark"):e.classList.remove("dark"),this.htmlElement=e},init:function(){this.htmlElement=document.documentElement,this.themeToggle=document.getElementById("theme-toggle"),this.themeToggle?(this.moonIcon=this.themeToggle.querySelector(".moon"),this.sunIcon=this.themeToggle.querySelector(".sun"),this.updateIcons(),this.setupThemeToggle()):setTimeout((()=>{this.themeToggle=document.getElementById("theme-toggle"),this.themeToggle&&(this.moonIcon=this.themeToggle.querySelector(".moon"),this.sunIcon=this.themeToggle.querySelector(".sun"),this.updateIcons(),this.setupThemeToggle())}),500)},updateIcons:function(){if(this.moonIcon&&this.sunIcon){this.htmlElement.classList.contains("dark")?(this.moonIcon.classList.remove("hidden"),this.sunIcon.classList.add("hidden")):(this.moonIcon.classList.add("hidden"),this.sunIcon.classList.remove("hidden"))}},setupThemeToggle:function(){this.themeToggle&&(this.themeToggle.removeEventListener("click",this._handleThemeToggle),this._handleThemeToggle=()=>{this.toggleTheme()},this.themeToggle.addEventListener("click",this._handleThemeToggle))},toggleTheme:function(){this.htmlElement.classList.toggle("dark");const e=this.htmlElement.classList.contains("dark");localStorage.setItem("theme",e?"dark":"light"),this.updateIcons(),document.dispatchEvent(new CustomEvent("themeChanged",{detail:{theme:e?"dark":"light"}}))},getCurrentTheme:function(){return this.htmlElement.classList.contains("dark")?"dark":"light"}};n.initTheme(),document.addEventListener("DOMContentLoaded",(function(){n.init()}))},function(e,t,i){i.r(t),i.d(t,{EditorManager:function(){return n}});const n={paths:{root:window.PATHS?window.PATHS.ROOT:"/",cms:window.PATHS?window.PATHS.CMS:"/content/",media:window.PATHS?window.PATHS.MEDIA:"../../../public/img"},editor:null,init:function(){return this.editor=new SimpleMDE({element:document.getElementById("editor"),spellChecker:!1,autosave:{enabled:!0},toolbar:["heading","bold","italic","quote","unordered-list","ordered-list","code","link","image"],shortcuts:{toggleBold:"Ctrl-B",toggleItalic:"Ctrl-I",drawLink:"Ctrl-K",toggleHeadingSmaller:"Ctrl-H",toggleHeadingBigger:"Shift-Ctrl-H",cleanBlock:"Ctrl-E",drawImage:"Ctrl-Alt-I",toggleBlockquote:"Ctrl-'",toggleOrderedList:"Ctrl-Alt-L",toggleUnorderedList:"Ctrl-L",toggleCodeBlock:"Ctrl-Alt-C",togglePreview:"Ctrl-P",toggleSideBySide:"F9",toggleFullScreen:"F11"}}),this.editor.codemirror.setOption("readOnly",!0),this.clearEditor(),this.setupEditorShortcuts(),window.editor=this.editor,this.editor},setupEditorShortcuts:function(){const e=document.querySelector(".save-file");this.editor.codemirror.setOption("extraKeys",{"Ctrl-S":function(t){return e&&e.disabled||document.dispatchEvent(new CustomEvent("editorSave")),!1},"Ctrl-Z":function(e){return e.undo(),!1},"Ctrl-Y":function(e){return e.redo(),!1},"Shift-Ctrl-Z":function(e){return e.redo(),!1}})},updateEditorTheme:function(e){if(!this.editor)return;const t=this.editor.codemirror.getWrapperElement();"dark"===e?(t.classList.add("cm-s-dark"),t.classList.remove("cm-s-light")):(t.classList.add("cm-s-light"),t.classList.remove("cm-s-dark"))},getContent:function(){return this.editor?this.editor.value():""},setContent:function(e){this.editor&&this.editor.value(e)},enable:function(){this.editor&&this.editor.codemirror.setOption("readOnly",!1)},disable:function(){this.editor&&this.editor.codemirror.setOption("readOnly",!0)},getEditor:function(){return this.editor},clearEditor:function(){this.editor&&this.editor.value("")}}},function(e,t,i){i.r(t),i.d(t,{FileManager:function(){return a}});var n=i(4);const a={paths:{root:window.PATHS?window.PATHS.ROOT:"/",cms:window.PATHS?window.PATHS.CMS:"/content/",media:window.PATHS?window.PATHS.MEDIA:"../../../public/img"},currentFile:"",mdList:null,saveBtn:null,currentFileEl:null,createNewBtn:null,formCreate:null,inputCreate:null,saveNewBtn:null,cancelNewBtn:null,mainImagePath:"",customFieldsVisibilityState:null,init:function(){this.mdList=document.querySelector(".md-list"),this.saveBtn=document.querySelector(".save-file"),this.currentFileEl=document.querySelector(".current-file"),this.createNewBtn=document.querySelector(".create-new"),this.formCreate=document.querySelector(".form-create"),this.inputCreate=document.querySelector(".create"),this.saveNewBtn=document.querySelector(".save-new"),this.cancelNewBtn=document.querySelector(".cancel-new"),this.mdList&&(this.setupEventListeners(),this.loadFileList())},setupEventListeners:function(){this.saveBtn&&this.saveBtn.addEventListener("click",(()=>this.saveFile())),this.createNewBtn&&this.createNewBtn.addEventListener("click",(()=>this.showCreateForm())),this.cancelNewBtn&&this.cancelNewBtn.addEventListener("click",(()=>this.hideCreateForm())),this.saveNewBtn&&this.inputCreate&&this.saveNewBtn.addEventListener("click",(()=>this.createNewFile())),document.addEventListener("keydown",(e=>{(e.ctrlKey||e.metaKey)&&"s"===e.key&&(e.preventDefault(),this.currentFile&&this.saveBtn&&!this.saveBtn.disabled&&this.saveFile())})),document.addEventListener("mainImageSelected",(e=>{e.detail&&e.detail.path&&(this.mainImagePath=e.detail.path)}))},showCreateForm:function(){this.formCreate&&(this.formCreate.classList.remove("hidden"),this.createNewBtn.classList.add("hidden"))},hideCreateForm:function(){this.formCreate&&(this.formCreate.classList.add("hidden"),this.createNewBtn.classList.remove("hidden"),this.inputCreate&&(this.inputCreate.value=""))},loadFileList:function(){if(!this.mdList)return;const e=window.getApiUrl?window.getApiUrl("?action=list"):"process.php?action=list";fetch(e,{credentials:"include",headers:{"X-Requested-With":"XMLHttpRequest"}}).then((e=>e.json())).then((e=>{if(0===e.length)return void(this.mdList.innerHTML='<li class="py-2 text-gray-400 dark:text-neutral-800 italic">No markdown files found</li>');const t=document.createDocumentFragment(),i=e=>t=>{t.target.closest(".delete-file")||this.loadFile(e)},n=e=>t=>{t.stopPropagation(),this.deleteFile(e)};e.forEach((e=>{const a=document.createElement("li");a.className="file-item",a.dataset.filename=e.toLowerCase(),a.dataset.searchableFilename=this.normalizeSearchString(e);const s=document.createElement("span");s.className="file-name flex-grow",s.textContent=e;const o=document.createElement("button");o.className="delete-file text-red-500 hover:text-red-700 dark:hover:text-red-400",o.dataset.file=e,o.innerHTML='\n            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">\n              <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />\n            </svg>\n          ',a.appendChild(s),a.appendChild(o),a.addEventListener("click",i(e)),o.addEventListener("click",n(e)),t.appendChild(a)})),this.mdList.innerHTML="",this.mdList.appendChild(t)})).catch((e=>{console.error("Error loading file list:",e),this.mdList.innerHTML='<li class="py-2 text-red-500">Error loading files</li>'}))},normalizeSearchString:function(e){return e.toLowerCase().replace(/[-_.]/g," ").replace(/\s+/g," ").trim()},loadFile:function(e){if(this.currentFile=e,this.currentFileEl&&(this.currentFileEl.textContent=e),this.mdList){this.mdList.querySelectorAll("li").forEach((e=>e.classList.remove("active")));const t=this.mdList.querySelector(`li[data-filename="${e.toLowerCase()}"]`);t&&t.classList.add("active")}const t=(new Date).getTime();this.hideCustomFieldsTemporarily(),this.mainImagePath="",this.radicalCleanupOfCustomFields(!0);const i=window.currentCollection||"",a=`${window.API_BASE_PATH||"api.php"}?action=read&file=${encodeURIComponent(e)}&t=${t}&collection=${encodeURIComponent(i)}`;fetch(a,{credentials:"include",headers:{"X-Requested-With":"XMLHttpRequest"}}).then((e=>e.text())).then((t=>{window.editor&&(window.editor.value(t),window.editor.codemirror.setOption("readOnly",!1)),this.saveBtn&&(this.saveBtn.disabled=!1),n.FieldManager.extractCustomFields(t),this.extractMainImage(t),this.forceUpdateCustomFields(),this.showCustomFieldsAgain(),document.dispatchEvent(new CustomEvent("fileLoaded",{detail:{filename:e,content:t}}))})).catch((e=>{console.error("Error loading file:",e),this.showCustomFieldsAgain()}))},extractMainImage:function(e){const t=e.match(/^---\s*\n([\s\S]*?)\n---\s*\n/);if(t&&t[1]){const e=/main_img\s*:\s*["']?([^"'\n]+)["']?/,i=t[1].match(e);if(i&&i[1]){const e=i[1];this.mainImagePath=e;const t=document.getElementById("main-image-path");t&&(t.value=e);const n=document.getElementById("main-image-preview"),a=document.getElementById("main-image-placeholder"),s=document.querySelector(".main-image-status");if(n&&a){const t=e.startsWith("/")?`../../../public${e}`:`../../../public/${e}`;n.src=t,n.classList.remove("hidden"),a.classList.add("hidden"),s&&(s.textContent="Image selected")}document.dispatchEvent(new CustomEvent("mainImageLoaded",{detail:{path:e}}))}else this.clearMainImagePreview()}else this.clearMainImagePreview()},clearMainImagePreview:function(){this.mainImagePath="";const e=document.getElementById("main-image-path");e&&(e.value="");const t=document.getElementById("main-image-preview"),i=document.getElementById("main-image-placeholder"),n=document.querySelector(".main-image-status");t&&i&&(t.src="",t.classList.add("hidden"),i.classList.remove("hidden"),n&&(n.textContent="No image selected"))},saveFile:function(){if(!this.currentFile)return;const e=document.createElement("div");e.className="fixed top-0 left-0 w-full h-1 bg-green-500 animate-pulse z-50",document.body.appendChild(e);let t="";window.editor&&(t=window.editor.value());const i=n.FieldManager.collectCustomFieldValues(),a=document.getElementById("main-image-path");if(a&&a.value){let e=a.value;e&&!e.startsWith("/")&&(e="/"+e),this.mainImagePath=e}let s=t;const o=/^---\s*\n([\s\S]*?)\n---\s*\n/,r=t.match(o);let l="---\n";for(const[e,t]of Object.entries(i))if(null!=t&&""!==t)if(Array.isArray(t)){l+=`${e}: [${t.map((e=>"string"==typeof e?`"${e}"`:e)).join(", ")}]\n`}else if("object"==typeof t)l+=`${e}: ${JSON.stringify(t)}\n`;else{const i=document.querySelector(`[name="${e}"]`),n=i?i.getAttribute("data-type"):null;let a=t;if("string"==typeof t)switch(a=t.trim().replace(/^"|"$/g,""),n){case"select":case"date":a=`"${a}"`;break;default:isNaN(a)&&(a=`"${a}"`)}l+=`${e}: ${a}\n`}if(this.mainImagePath){let e=this.mainImagePath;e&&!e.startsWith("/")&&(e="/"+e),l+=`main_img: "${e}"\n`}l+="---\n\n",s=r?t.replace(o,l):l+t,document.dispatchEvent(new CustomEvent("beforeFileSave",{detail:{filename:this.currentFile,content:s}})),this.saveFileToServer(s,e)},saveFileToServer:function(e,t){if(!this.currentFile)return console.error("Error: No filename specified!"),alert("Error: No se ha especificado un nombre de archivo."),void t.remove();console.log("Guardando archivo:",this.currentFile);const i=e.includes("data:image")&&e.includes("base64"),n=e.length;if(console.log("Tamaño del contenido:",n,"caracteres"),console.log("Contiene imágenes base64:",i?"Sí":"No"),i&&n>5e5){console.log("Detectado contenido grande con imágenes base64. Usando XMLHttpRequest..."),console.log("Tamaño del contenido:",n,"caracteres");const i=window.API_BASE_PATH||"process.php",a=window.CURRENT_COLLECTION||"",s=`${i}?action=write&file=${encodeURIComponent(this.currentFile)}&collection=${encodeURIComponent(a)}`;console.log("URL para XMLHttpRequest:",s);const o=new XMLHttpRequest;return o.open("POST",s,!0),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.setRequestHeader("X-Requested-With","XMLHttpRequest"),o.onload=()=>{try{const e=JSON.parse(o.responseText);e.success?(console.log("Archivo guardado exitosamente via XMLHttpRequest"),t.remove()):(console.error("Error al guardar archivo:",e.message),alert("Error al guardar archivo: "+e.message),t.remove())}catch(e){console.error("Error al procesar respuesta:",e),alert("Error al guardar: "+e.message),t.remove()}},o.onerror=()=>{console.error("Error de red al guardar archivo"),alert("Error de red al guardar archivo. Por favor, intente nuevamente."),t.remove()},void o.send("content="+encodeURIComponent(e))}const a=new URLSearchParams;a.append("action","write"),a.append("file",this.currentFile),a.append("content",e);const s=window.API_BASE_PATH||"process.php",o=window.CURRENT_COLLECTION||"",r=`${s}?collection=${encodeURIComponent(o)}`;console.log("URL para fetch:",r),console.log("Tamaño del contenido:",n,"caracteres");const l={method:"POST",credentials:"include",mode:"cors",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},body:a.toString()};console.log("Body enviado:",a.toString().substring(0,150)+"..."),console.log("Fetch options:",JSON.stringify(l,((e,t)=>"body"===e?"[Request Body]":t),2));const d=(e,t)=>{const i=e.url;return console.log(`Respuesta recibida (${t}) - Status:`,e.status,"Status Text:",e.statusText),console.log("URL completa de la solicitud:",i),console.log("Encabezados de respuesta:",JSON.stringify(Object.fromEntries([...e.headers]))),e.ok?e.text().then((e=>{console.log(`Respuesta completa (${t}):`,e);try{return JSON.parse(e)}catch(n){throw console.error(`Error al parsear JSON (${t}):`,n),console.log(`Respuesta recibida (${t}) (primeros 150 caracteres):`,e.substring(0,150)),new Error(`Respuesta no válida: ${e.substring(0,150)}... (URL: ${i})`)}})):(console.error(`Error HTTP (${t}):`,e.status,e.statusText),e.text().then((n=>{throw console.error(`Contenido de respuesta de error (${t}):`,n),new Error(`Error HTTP ${e.status}: ${n.substring(0,150)}... (URL: ${i})`)})))};return fetch(r,l).then((e=>d(e,"POST"))).catch((t=>{console.error("Error en método POST:",t),console.log("Intentando método alternativo GET...");const i=`${s}?action=write&file=${encodeURIComponent(this.currentFile)}&content=${encodeURIComponent(e)}&secure_write=true&collection=${encodeURIComponent(o)}`;console.log("URL alternativa (truncada):",i.substring(0,150)+"...");return fetch(i,{method:"GET",credentials:"include",mode:"cors",headers:{"X-Requested-With":"XMLHttpRequest","Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache"}}).then((e=>d(e,"GET")))})).then((e=>{if(e.success){t.remove();const e=this.currentFile;document.dispatchEvent(new CustomEvent("afterFileSave",{detail:{filename:e,success:!0}}));const i=(new Date).getTime();window.location.href=window.location.pathname+`?file=${encodeURIComponent(e)}&nocache=${i}`}else alert("Error saving file: "+(e.error||"Unknown error")),t.remove(),document.dispatchEvent(new CustomEvent("fileSaveError",{detail:{filename:this.currentFile,error:e.error||"Unknown error"}}))})).catch((e=>{console.error("Error saving file:",e),alert("Error saving file: "+e.message),t.remove(),document.dispatchEvent(new CustomEvent("fileSaveError",{detail:{filename:this.currentFile,error:e.message}}))}))},createNewFile:function(){const e=this.inputCreate?this.inputCreate.value.trim():"";if(!e)return void alert("Please enter a filename");const t=e.endsWith(".md")?e:`${e}.md`,i=(new Date).toISOString().split("T")[0],n={};document.querySelectorAll(".custom-field").forEach((e=>{const t=e.dataset.fieldName,i=e.dataset.defaultValue;t&&i&&(n[t]=i)})),n.publish_date=i,n.status="published";let a="---\n";for(const[e,t]of Object.entries(n))null!=t&&""!==t&&(a+="string"==typeof t?`${e}: "${t}"\n`:`${e}: ${t}\n`);a+="---\n\n";const s=a,o=window.API_BASE_PATH||"api.php",r=window.CURRENT_COLLECTION||"",l=`${o}?collection=${encodeURIComponent(r)}`;console.log("Creating new file using URL:",l),fetch(l,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},body:`action=create&file=${encodeURIComponent(t)}&content=${encodeURIComponent(s)}`}).then((e=>e.json())).then((e=>{e.success?(this.loadFileList(),this.loadFile(t),this.hideCreateForm(),document.dispatchEvent(new CustomEvent("newFileCreated",{detail:{filename:t}}))):alert("Error creating file: "+e.message)})).catch((e=>{console.error("Error creating file:",e),alert("Error creating file")}))},deleteFile:function(e){if(!confirm(`¿Estás seguro de que deseas mover "${e}" a la papelera de reciclaje?`))return;const t=window.API_BASE_PATH||"api.php",i=window.CURRENT_COLLECTION||"",n=`${t}?collection=${encodeURIComponent(i)}`;console.log("Deleting file using URL:",n),fetch(n,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},body:`action=delete&filename=${encodeURIComponent(e)}`}).then((e=>e.json())).then((t=>{t.success?(this.showFlashMessage("Archivo movido a la papelera de reciclaje","success"),this.loadFileList(),this.currentFile===e&&(this.currentFile="",this.currentFileEl&&(this.currentFileEl.textContent="Select a file"),window.editor&&(window.editor.value(""),window.editor.codemirror.setOption("readOnly",!0)),this.saveBtn&&(this.saveBtn.disabled=!0),document.dispatchEvent(new CustomEvent("fileDeleted",{detail:{filename:e}})))):alert("Error al mover el archivo a la papelera: "+t.message)})).catch((e=>{console.error("Error al mover el archivo a la papelera:",e),alert("Error al mover el archivo a la papelera")}))},showFlashMessage:function(e,t="info"){let i=document.querySelector(".flash-message");switch(i?i.className="flash-message":(i=document.createElement("div"),i.className="flash-message",document.body.appendChild(i)),t){case"success":i.classList.add("bg-green-500","text-white");break;case"error":i.classList.add("bg-red-500","text-white");break;case"warning":i.classList.add("bg-yellow-500","text-white");break;default:i.classList.add("bg-blue-500","text-white")}i.textContent=e,setTimeout((()=>{i.classList.add("active")}),10),setTimeout((()=>{i.classList.remove("active")}),3e3)},getCurrentFile:function(){return this.currentFile},hideCustomFieldsTemporarily:function(){this.customFieldsVisibilityState={leftFields:!document.querySelector(".custom-fields-section.left-fields")?.classList.contains("hidden"),rightFields:!document.querySelector(".custom-fields-section.right-fields")?.classList.contains("hidden"),mainFields:!document.querySelector(".custom-fields-section.main-fields")?.classList.contains("hidden")};document.querySelectorAll(".custom-field").forEach((e=>{e.dataset.originalOpacity=e.style.opacity||"1",e.style.opacity="0",e.style.transition="none"}))},showCustomFieldsAgain:function(){n.FieldManager.showCustomFields();if(0===document.querySelectorAll(".custom-field").length){document.querySelectorAll(".custom-fields-section").forEach((e=>{e.classList.contains("hidden")&&e.classList.remove("hidden")})),setTimeout((()=>{document.querySelectorAll(".custom-field")}),10)}setTimeout((()=>{n.FieldManager.showCustomFields(),document.querySelectorAll(".custom-field").forEach((e=>{e.style.transition="opacity 0.2s ease-in-out",e.style.opacity="1"})),document.querySelectorAll(".custom-fields-section").forEach((e=>{e.classList.remove("hidden"),e.style.display="block"}))}),50)},radicalCleanupOfCustomFields:function(e=!1){n.FieldManager.customFieldValues={};const t=document.querySelectorAll(".custom-field");t.forEach((t=>{if(!t.dataset.fieldName)return;const i=t.querySelectorAll("input, textarea, select"),n=null!==t.querySelector(".gallery-data"),a=null!==t.querySelector(".tags-data");if(n){const e=t.querySelector(".gallery-images-container"),i=t.querySelector(".gallery-data");e&&(e.innerHTML=""),i&&(i.value="[]")}else if(a){const e=t.querySelector(".tags-list"),i=t.querySelector(".tags-data");e&&(e.innerHTML=""),i&&(i.value="[]")}else i.forEach((t=>{"checkbox"===t.type||"radio"===t.type?t.checked=!1:"SELECT"===t.tagName?(t.selectedIndex=0,e||t.dispatchEvent(new Event("change",{bubbles:!0}))):(t.value="",e||t.dispatchEvent(new Event("input",{bubbles:!0})))}))}))},forceUpdateCustomFields:function(){const e=document.querySelectorAll(".custom-field");e.forEach((e=>{const t=e.dataset.fieldName;if(!t)return;const i=n.FieldManager.customFieldValues[t],a=null!==e.querySelector(".gallery-data"),s=null!==e.querySelector(".tags-data");if(a)n.FieldManager.updateGalleryField(e,i||[]);else if(s)n.FieldManager.updateTagsField(e,i||[]);else{e.querySelectorAll("input, textarea, select").forEach((e=>{"checkbox"===e.type?e.checked="true"===i||!0===i:"SELECT"===e.tagName?(i?e.value=i:e.selectedIndex=0,e.dispatchEvent(new Event("change",{bubbles:!0}))):(e.value=i||"",e.dispatchEvent(new Event("input",{bubbles:!0})))}))}}))}}},function(e,t,i){i.r(t),i.d(t,{FieldManager:function(){return n}});const n={paths:{root:window.PATHS?window.PATHS.ROOT:"/",cms:window.PATHS?window.PATHS.CMS:"/content/",media:window.PATHS?window.PATHS.MEDIA:"../../../public/img"},customFieldValues:{},init:function(){this.initializeDateFields(),this.initializeGalleryButtons(),this.initializeImageButtons(),this.hideCustomFields(),document.addEventListener("newFileCreated",(()=>{this.handleNewFile()}))},initializeImageButtons:function(){document.querySelectorAll(".image-select").forEach((e=>{const t=e._clickListener;t&&e.removeEventListener("click",t);const i=t=>{t.preventDefault(),console.log("Clic en botón de imagen:",t.target);const i=e.getAttribute("data-image-id");console.log("ID de imagen:",i);const n=document.getElementById("media-modal");if(!n)return console.error("Error: El modal de la biblioteca de medios no existe en el DOM"),void alert("Error: No se pudo abrir la biblioteca de medios. Por favor, recarga la página.");if(window.App&&window.App.MediaManager){console.log("Abriendo modal directamente con MediaManager");try{n.classList.remove("hidden"),n.style.display="",document.body.classList.add("overflow-hidden"),window.App.MediaManager.openModal("image",i)}catch(e){console.error("Error al abrir el modal:",e),n.classList.remove("hidden"),n.style.display="",document.body.classList.add("overflow-hidden")}}else console.error("MediaManager no está disponible"),console.log("Disparando evento selectForImage como fallback"),document.dispatchEvent(new CustomEvent("selectForImage",{detail:{active:!0,imageId:i}})),n.classList.remove("hidden"),n.style.display="",document.body.classList.add("overflow-hidden")};e._clickListener=i,e.addEventListener("click",i)})),document.addEventListener("click",(e=>{if(e.target.closest(".image-remove")){const t=e.target.closest(".image-remove"),i=t.closest(".image-preview-wrapper"),n=t.closest(".image-field"),a=n.querySelector(".image-data");if(i&&a){i.remove(),a.value="";const e=n.querySelector(".image-select");e&&(e.textContent="Select Image")}}}))},initializeGalleryButtons:function(){document.querySelectorAll(".gallery-add-images").forEach((e=>{e.addEventListener("click",(()=>{const t=e.getAttribute("data-gallery-id");document.dispatchEvent(new CustomEvent("selectForGallery",{detail:{active:!0,galleryId:t}}))}))}))},showCustomFields:function(){const e=document.querySelector(".custom-fields-section.left-fields"),t=document.querySelector(".custom-fields-section.right-fields"),i=document.querySelector(".custom-fields-section.main-fields");e&&e.classList.remove("hidden"),t&&t.classList.remove("hidden"),i&&i.classList.remove("hidden")},hideCustomFields:function(){const e=document.querySelector(".custom-fields-section.left-fields"),t=document.querySelector(".custom-fields-section.right-fields"),i=document.querySelector(".custom-fields-section.main-fields");e&&e.classList.add("hidden"),t&&t.classList.add("hidden"),i&&i.classList.add("hidden")},extractCustomFields:function(e){this.customFieldValues={};const t=e.match(/^---\s*\n([\s\S]*?)\n---\s*\n/);if(t&&t[1]){const e=t[1];e.split("\n").forEach((e=>{const t=e.match(/^([a-zA-Z0-9_]+):\s*(.*?)$/);if(t&&"categories"!==t[1]){const e=t[1];let i=t[2].trim();const n=document.querySelector(`[name="${e}"]`),a=n?n.getAttribute("data-type"):null;if("select"!==a&&"date"!==a&&/^["'].*["']$/.test(i)&&(i=i.substring(1,i.length-1)),"gallery"===e||"tags"===e||i.startsWith("[")&&i.endsWith("]"))try{const t=JSON.parse(i);this.customFieldValues[e]=t}catch(t){if(i.startsWith("[")&&i.endsWith("]")){const t=i.substring(1,i.length-1).split(",").map((e=>(e=e.trim(),/^["'].*["']$/.test(e)?e.substring(1,e.length-1):e))).filter((e=>e.length>0));this.customFieldValues[e]=t}else this.customFieldValues[e]=i}else this.customFieldValues[e]=i}}));const i=e.match(/excerpt:\s*["']?([\s\S]*?)["']?(?=\n[a-zA-Z0-9_]+:|$)/);if(i&&i[1]){let e=i[1].trim();/^["'].*["']$/.test(e)&&(e=e.substring(1,e.length-1)),this.customFieldValues.excerpt=e}}this.updateCustomFieldsWithValues(this.customFieldValues),this.showCustomFields(),document.dispatchEvent(new CustomEvent("customFieldsUpdated",{detail:{values:this.customFieldValues}}))},updateCustomFieldsWithValues:function(e){if(!e)return;this.showCustomFields();document.querySelectorAll(".custom-field").forEach((t=>{const i=t.dataset.fieldName;if(i&&void 0!==e[i]){const n=e[i],a=t.querySelector(`[name="custom_fields[${i}]"]`);if(a)if("checkbox"===a.type)a.checked="true"===n||!0===n;else if("SELECT"===a.tagName){if(a.options.length<=1&&a.hasAttribute("data-options"))try{const e=JSON.parse(a.getAttribute("data-options")),t=JSON.parse(a.getAttribute("data-option-labels"));for(;a.options.length>1;)a.remove(1);for(let i=0;i<e.length;i++){const n=document.createElement("option");n.value=e[i],n.textContent=t[i],n.className="text-neutral-800 dark:text-white bg-white dark:bg-neutral-800",a.appendChild(n)}}catch(e){console.error("Error al cargar opciones del select:",e)}a.value=n,a.dispatchEvent(new Event("change",{bubbles:!0}))}else a.classList.contains("gallery-data")?this.updateGalleryField(t,n):a.classList.contains("tags-data")?this.updateTagsField(t,n):a.classList.contains("image-data")?this.updateImageField(t,n):(a.value=n,a.dispatchEvent(new Event("input",{bubbles:!0})))}else if(i){const e=t.querySelector(`[name="custom_fields[${i}]"]`);if(e)if("checkbox"===e.type)e.checked=!1;else if("SELECT"===e.tagName){if(e.options.length<=1&&e.hasAttribute("data-options"))try{const t=JSON.parse(e.getAttribute("data-options")),i=JSON.parse(e.getAttribute("data-option-labels"));for(;e.options.length>1;)e.remove(1);for(let n=0;n<t.length;n++){const a=document.createElement("option");a.value=t[n],a.textContent=i[n],a.className="text-neutral-800 dark:text-white bg-white dark:bg-neutral-800",e.appendChild(a)}}catch(e){console.error("Error al cargar opciones del select:",e)}e.selectedIndex=0,e.dispatchEvent(new Event("change",{bubbles:!0}))}else e.classList.contains("gallery-data")?this.updateGalleryField(t,[]):e.classList.contains("tags-data")?this.updateTagsField(t,[]):e.classList.contains("image-data")?this.updateImageField(t,""):(e.value="",e.dispatchEvent(new Event("input",{bubbles:!0})))}}))},handleNewFile:function(){this.customFieldValues={};const e={};document.querySelectorAll(".custom-field").forEach((t=>{const i=t.dataset.fieldName,n=t.dataset.defaultValue;i&&n&&(e[i]=n)})),document.querySelector('.custom-field[data-field-name="status"]')&&(e.status="published"),this.updateCustomFieldsWithValues(e),this.initializeDateFields()},updateGalleryField:function(e,t){const i=e.querySelector(".gallery-images-container"),n=e.querySelector(".gallery-data");if(!i||!n)return;i.innerHTML="";let a=t;if("string"==typeof t)try{a=JSON.parse(t)}catch(e){a=t.split(",").map((e=>e.trim()))}Array.isArray(a)||(a=a?[a]:[]),n.value=JSON.stringify(a),a.forEach((e=>{if(!e)return;let t=e;e.startsWith("/")?t=`../../../public${e}`:e.startsWith("http")||e.startsWith("../../../public")||(t=`../../../public/${e}`);const a=document.createElement("div");a.className="gallery-image-item relative border border-neutral-300 dark:border-neutral-700 rounded overflow-hidden",a.innerHTML=`\n        <img src="${t}" class="w-full h-20 object-cover">\n        <button type="button" class="gallery-remove-image absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center" data-path="${e}">\n          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">\n            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />\n          </svg>\n        </button>\n      `;const s=a.querySelector(".gallery-remove-image");s&&s.addEventListener("click",(()=>{a.remove();const t=JSON.parse(n.value||"[]").filter((t=>t!==e));n.value=JSON.stringify(t)})),i.appendChild(a)})),e.dispatchEvent(new CustomEvent("galleryUpdated",{bubbles:!0,detail:{galleryImages:a}}))},updateTagsField:function(e,t){e.querySelector(".tags-field")?.dataset.tagsId;const i=e.querySelector(".tags-list"),n=e.querySelector(".tags-data"),a=e.querySelector(".tag-input"),s=e.querySelector(".add-tag");if(!i||!n)return;i.innerHTML="";let o=t;if(!Array.isArray(o))if("string"==typeof o)try{o=JSON.parse(o)}catch(e){o=o.split(",").map((e=>e.trim()))}else o=[];if(o=o.filter((e=>e&&e.trim())),n.value=JSON.stringify(o),o.forEach((t=>{t&&t.trim()&&this.addTagToField(e,t.trim())})),s&&a){const t=s.cloneNode(!0);s.parentNode.replaceChild(t,s);const i=a.cloneNode(!0);a.parentNode.replaceChild(i,a),t.addEventListener("click",(()=>{const t=i.value.trim();t&&(this.addTagToField(e,t),i.value="",this.updateTagsDataField(e))})),i.addEventListener("keydown",(t=>{if("Enter"===t.key){t.preventDefault();const n=i.value.trim();n&&(this.addTagToField(e,n),i.value="",this.updateTagsDataField(e))}}))}e.dispatchEvent(new CustomEvent("tagsUpdated",{bubbles:!0,detail:{tagsArray:o}}))},addTagToField:function(e,t){const i=e.querySelector(".tags-list");if(!i)return;if(Array.from(i.querySelectorAll(".tag-item span")).map((e=>e.textContent)).includes(t))return;const n=document.createElement("div");n.className="tag-item bg-neutral-300 dark:bg-neutral-700 text-neutral-700 dark:text-neutral-300 px-2 py-1 rounded text-sm flex items-center",n.innerHTML=`\n      <span>${t}</span>\n      <button type="button" class="tag-remove ml-1 text-red-500 hover:text-red-700 dark:hover:text-red-400" data-tag="${t}">\n        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">\n          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />\n        </svg>\n      </button>\n    `;const a=n.querySelector(".tag-remove");a&&a.addEventListener("click",(()=>{n.remove(),this.updateTagsDataField(e)})),i.appendChild(n)},updateTagsDataField:function(e){const t=e.querySelectorAll(".tag-item"),i=e.querySelector(".tags-data");if(!i)return;const n=[];t.forEach((e=>{const t=e.querySelector("span").textContent;n.push(t)})),i.value=JSON.stringify(n)},updateImageField:function(e,t){const i=e.querySelector(".image-container"),n=e.querySelector(".image-data");if(!i||!n)return;if(i.innerHTML="",!t||""===t){n.value="";const t=e.querySelector(".image-select");return void(t&&(t.textContent="Select Image"))}n.value=t;let a=t;t.startsWith("/")?a=`../../../public${t}`:t.includes("public/img")?a=t.replace(/^(\.\.\/)*/,"../../../"):t.startsWith("../../../public/")||t.startsWith("http")||(a=`../../../public/${t}`);const s=document.createElement("div");s.className="image-preview-wrapper",s.innerHTML=`\n      <img src="${a}">\n      <button type="button" class="image-remove" data-path="${t}">\n        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">\n          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />\n        </svg>\n      </button>\n    `,i.appendChild(s);const o=e.querySelector(".image-select");o&&(o.textContent="Change Image")},collectCustomFieldValues:function(){const e={};return[...document.querySelectorAll(".custom-fields-section.left-fields .custom-field"),...document.querySelectorAll(".custom-fields-section.right-fields .custom-field"),...document.querySelectorAll(".custom-fields-section.main-fields .custom-field")].forEach((t=>{const i=t.getAttribute("data-field-name"),n=t.querySelector('input[type="checkbox"]');if(i&&n)return void(e[i]=n.checked?"true":"false");const a=t.querySelector(".tags-data, .gallery-data"),s=t.querySelector("input:not(.tags-data):not(.gallery-data), textarea, select"),o=a||s;if(i&&o)if(o.classList.contains("tags-data")||o.classList.contains("gallery-data"))try{e[i]=JSON.parse(o.value)}catch(t){e[i]=o.value}else e[i]=o.value})),e},initializeDateFields:function(){const e=document.querySelectorAll("input.date-picker");0!==e.length&&e.forEach((e=>{e.addEventListener("change",(function(){this.value}));e.getAttribute("name")||e.getAttribute("data-field-name");if(!e.value){const t=(new Date).toISOString().split("T")[0];e.value=t;const i=new Event("change",{bubbles:!0});e.dispatchEvent(i)}}))}}},function(e,t,i){i.r(t),i.d(t,{TagsManager:function(){return n}});const n={paths:{root:window.PATHS?window.PATHS.ROOT:"/",cms:window.PATHS?window.PATHS.CMS:"/content/",media:window.PATHS?window.PATHS.MEDIA:"../../../public/img"},currentTags:[],tagsField:null,tagsFieldContainer:null,tagsList:null,tagInput:null,addTagBtn:null,init:function(){this.tagsField=document.querySelector('.custom-field[data-field-name="tags"]'),this.tagsField?(this.tagsFieldContainer=this.tagsField.querySelector(".tags-field"),this.tagsList=this.tagsField.querySelector(".tags-list"),this.tagInput=this.tagsField.querySelector(".tag-input"),this.addTagBtn=this.tagsField.querySelector(".add-tag"),this.tagsFieldContainer&&this.tagsList?this.setupEventListeners():console.warn("Tags elements not found within tags field")):console.warn("Tags field not found")},setupEventListeners:function(){const e=this;this.addTagBtn&&this.tagInput&&(this.addTagBtn.addEventListener("click",(function(){e.addTag(e.tagInput.value)})),this.tagInput.addEventListener("keydown",(function(t){"Enter"===t.key&&(t.preventDefault(),e.addTag(e.tagInput.value))}))),this.setupTagRemoveButtons()},setupTagRemoveButtons:function(){if(!this.tagsList)return;this.tagsList.querySelectorAll(".tag-remove").forEach((e=>{e.addEventListener("click",(()=>{const t=e.getAttribute("data-tag");t&&this.removeTag(t)}))}))},extractTags:function(e){if(!this.tagsField)return;this.currentTags=[];const t=e.match(/^---\s*\n([\s\S]*?)\n---\s*\n/);if(t&&t[1]){const e=t[1],i=e.match(/tags:\s*\[(.*?)\]/);if(i&&i[1])this.currentTags=i[1].split(",").map((e=>e.trim().replace(/['"]/g,""))).filter((e=>e.length>0));else{const t=e.match(/categories:\s*\[(.*?)\]/);t&&t[1]&&(this.currentTags=t[1].split(",").map((e=>e.trim().replace(/['"]/g,""))).filter((e=>e.length>0)))}}this.updateTagsList(),this.updateTagsDataField()},updateTagsList:function(){if(!this.tagsList)return;if(this.tagsList.innerHTML="",0===this.currentTags.length)return;const e=this;this.currentTags.forEach((t=>{const i=document.createElement("div");i.className="tag-item bg-neutral-300 dark:bg-neutral-700 text-neutral-700 dark:text-neutral-300 px-2 py-1 rounded text-sm flex items-center",i.innerHTML=`\n        <span>${t}</span>\n        <button class="tag-remove ml-1 text-red-500 hover:text-red-700 dark:hover:text-red-400" data-tag="${t}">\n          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">\n            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />\n          </svg>\n        </button>\n      `;const n=i.querySelector(".tag-remove");n&&n.addEventListener("click",(function(){e.removeTag(t)})),e.tagsList.appendChild(i)}))},addTag:function(e){(e=e.trim())&&(this.currentTags.includes(e)?alert("Tag already exists"):(this.currentTags.push(e),this.updateTagsList(),this.updateTagsDataField(),this.tagInput.value=""))},removeTag:function(e){this.currentTags=this.currentTags.filter((t=>t!==e)),this.updateTagsList(),this.updateTagsDataField()},updateTagsDataField:function(){if(!this.tagsField)return;const e=this.tagsField.querySelector("input.tags-data");e&&(e.value=JSON.stringify(this.currentTags),e.dispatchEvent(new Event("change",{bubbles:!0})))}}},function(e,t,i){i.r(t),i.d(t,{SearchManager:function(){return n}});const n={paths:{root:window.PATHS?window.PATHS.ROOT:"/",cms:window.PATHS?window.PATHS.CMS:"/content/",media:window.PATHS?window.PATHS.MEDIA:"../../../public/img"},searchForm:null,searchInput:null,init:function(){this.searchForm=document.querySelector(".search-form"),this.searchInput=document.querySelector(".search-input"),this.searchForm&&this.searchInput?(this.searchInput&&(this.searchInput.setAttribute("autocomplete","off"),this.searchInput.setAttribute("data-no-autocomplete","true"),this.searchInput.classList.add("no-simplemde-autocomplete")),this.searchForm.addEventListener("submit",(e=>{e.preventDefault();const t=this.searchInput.value.trim();this.searchFiles(t)})),this.searchInput.addEventListener("keyup",(()=>{const e=this.searchInput.value.trim();this.searchFiles(e)}))):console.warn("Search elements not found")},normalizeSearchString:function(e){return e.toLowerCase().replace(/[-_.]/g," ").replace(/\s+/g," ").trim()},searchFiles:function(e){const t=document.querySelector(".md-list");if(!t)return;const i=this.normalizeSearchString(e),n=!!document.startViewTransition;this.prepareElementsForTransition(t);const a=()=>{const e=Array.from(t.querySelectorAll(".file-item")),n=t.querySelector(".no-results");n&&n.remove();let a=0;if(e.forEach((e=>{const t=e.dataset.searchableFilename,n=e.dataset.filename||t||`file-${Math.random().toString(36).substr(2,9)}`;e.style.viewTransitionName=`file-transition-${n.replace(/[^a-z0-9]/gi,"-")}`;t.includes(i)?(e.style.display="flex",e.setAttribute("data-visible","true"),a++):(e.style.display="none",e.setAttribute("data-visible","false"))})),0===a&&e.length>0){const e=document.createElement("li");e.className="py-2 text-neutral-800 dark:text-gray-400 italic no-results",e.textContent="No matching files found",e.style.viewTransitionName="no-results",t.appendChild(e)}};n?document.startViewTransition((()=>a())):a()},prepareElementsForTransition:function(e){if(!e)return;e.style.viewTransitionName="md-list-container";Array.from(e.querySelectorAll(".file-item")).forEach(((e,t)=>{const i=(e.dataset.filename||e.querySelector(".file-item-text")?.textContent||`file-${t}`).replace(/[^a-z0-9]/gi,"-");e.dataset.transitionId=i,e.style.viewTransitionName=`file-transition-${i}`}))}}},function(e,t,i){i.r(t),i.d(t,{MediaManager:function(){return n}});const n={config:{basePath:window.PATHS?window.PATHS.MEDIA+"/":"../../../public/img/",publicPath:window.PATHS?window.PATHS.MEDIA+"/":"../../../public/img/"},modal:null,modalContent:null,mediaGrid:null,mediaLoading:null,mediaHome:null,currentPath:null,uploadInput:null,createDirBtn:null,closeModalBtn:null,openMediaBtn:null,buildImagePath:function(e,t=!0){const i=e.startsWith("/")?e.substring(1):e;if(i.includes(this.config.publicPath))return t?i.replace(this.config.publicPath,this.config.basePath):i;return(t?this.config.basePath:this.config.publicPath)+i},modeIndicator:null,modalFooter:null,selectedCount:null,confirmSelectionBtn:null,currentMediaPath:"",currentMode:"editor",selectedImages:[],currentGalleryId:null,currentImageId:null,isLoading:!1,init:function(){if(this.modal=document.getElementById("media-modal"),this.mediaGrid=document.querySelector(".media-grid"),this.mediaLoading=document.querySelector(".media-loading"),this.mediaHome=document.querySelector(".media-home"),this.currentPath=document.querySelector(".current-path"),this.uploadInput=document.getElementById("upload-image"),this.createDirBtn=document.getElementById("create-dir-btn"),this.closeModalBtn=document.getElementById("close-media-modal"),this.openMediaBtn=document.getElementById("open-media-library"),this.modeIndicator=document.getElementById("media-mode-indicator"),this.modalFooter=document.getElementById("media-modal-footer"),this.selectedCount=document.getElementById("selected-count"),this.confirmSelectionBtn=document.getElementById("confirm-selection"),this.modal){if(!this.openMediaBtn){const e=document.querySelectorAll("#open-media-library");if(e.length>0)this.openMediaBtn=e[0];else{const e=new MutationObserver((t=>{for(const i of t)if("childList"===i.type){const t=document.getElementById("open-media-library");if(t&&!this.openMediaBtn){this.openMediaBtn=t,this.setupOpenMediaButtonEvent(),e.disconnect();break}}}));e.observe(document.body,{childList:!0,subtree:!0})}}this.createDirectoryModal(),this.setupEventListeners(),this.setupMutationObserver()}},setupEventListeners:function(){this.setupOpenMediaButtonEvent(),this.closeModalBtn&&this.closeModalBtn.addEventListener("click",(()=>{this.closeModal()})),this.mediaHome&&this.mediaHome.addEventListener("click",(()=>{this.loadMedia("")})),this.uploadInput&&this.uploadInput.addEventListener("change",(e=>{e.target.files.length>0&&this.uploadImage(e.target.files)})),this.createDirBtn&&this.createDirBtn.addEventListener("click",(()=>{this.showCreateDirectoryModal()})),this.confirmSelectionBtn&&this.confirmSelectionBtn.addEventListener("click",(()=>{this.confirmGallerySelection()})),document.addEventListener("selectForMainImage",(e=>{e.detail&&e.detail.active&&this.openModal("main-image")})),document.addEventListener("selectForGallery",(e=>{e.detail&&e.detail.active&&e.detail.galleryId&&this.openModal("gallery",e.detail.galleryId)})),document.addEventListener("selectForImage",(e=>{if(console.log("Evento selectForImage recibido:",e.detail),e.detail&&e.detail.active){const t=e.detail.imageId||null;console.log("Abriendo modal en modo imagen con ID:",t),this.openModal("image",t)}else console.log("El evento no tiene los detalles necesarios")}))},setupOpenMediaButtonEvent:function(){this.openMediaBtn?(this._openModalHandler&&this.openMediaBtn.removeEventListener("click",this._openModalHandler),this._openModalHandler=e=>{e.preventDefault(),console.log("Clic en botón principal de la biblioteca de medios");const t=this.openMediaBtn.getAttribute("data-media-mode")||"editor",i=this.openMediaBtn.getAttribute("data-gallery-id")||null,n=document.getElementById("media-modal");if(!n)return console.error("Error: El modal de la biblioteca de medios no existe en el DOM"),void alert("Error: No se pudo abrir la biblioteca de medios. Por favor, recarga la página.");try{n.classList.remove("hidden"),n.style.display="",document.body.classList.add("overflow-hidden"),this.openModal(t,i)}catch(e){console.error(`Error al abrir el modal en modo ${t}:`,e),n.classList.remove("hidden"),n.style.display="",document.body.classList.add("overflow-hidden"),this.currentMode=t,"gallery"===t&&(this.currentGalleryId=i,this.currentImageId=null),this.loadMedia(this.currentMediaPath||"")}},this.openMediaBtn.addEventListener("click",this._openModalHandler)):console.warn("Botón principal de la biblioteca de medios no encontrado")},setupMutationObserver:function(){if(void 0===window.MutationObserver)return void console.warn("MutationObserver no está disponible");this.setupMediaButtons();new window.MutationObserver((e=>{let t=!1;e.forEach((e=>{e.addedNodes.length&&e.addedNodes.forEach((e=>{1===e.nodeType&&(e.hasAttribute("data-media-mode")||e.querySelector("[data-media-mode]")||e.classList.contains("media-button")||e.querySelector(".media-button"))&&(t=!0)}))})),t&&this.setupMediaButtons()})).observe(document.body,{childList:!0,subtree:!0})},setupMediaButtons:function(){const e=(e,t=null)=>i=>{i.preventDefault(),console.log(`Clic en botón de modo: ${e}${t?` con ID: ${t}`:""}`);const n=document.getElementById("media-modal");if(!n)return console.error("Error: El modal de la biblioteca de medios no existe en el DOM"),void alert("Error: No se pudo abrir la biblioteca de medios. Por favor, recarga la página.");try{n.classList.remove("hidden"),n.style.display="",document.body.classList.add("overflow-hidden"),this.openModal(e,t)}catch(i){console.error(`Error al abrir el modal en modo ${e}:`,i),n.classList.remove("hidden"),n.style.display="",document.body.classList.add("overflow-hidden"),this.currentMode=e,"gallery"===e?(this.currentGalleryId=t,this.currentImageId=null):"image"===e&&(this.currentImageId=t,this.currentGalleryId=null),this.loadMedia(this.currentMediaPath||"")}},t=document.getElementById("open-media-library");if(t){t._clickHandler&&t.removeEventListener("click",t._clickHandler);const i=e("editor");t._clickHandler=i,t.addEventListener("click",i)}document.querySelectorAll('[data-media-mode="main-image"]').forEach((t=>{t._clickHandler&&t.removeEventListener("click",t._clickHandler);const i=e("main-image");t._clickHandler=i,t.addEventListener("click",i)})),document.querySelectorAll('[data-media-mode="gallery"]').forEach((t=>{t._clickHandler&&t.removeEventListener("click",t._clickHandler);const i=t.getAttribute("data-gallery-id"),n=e("gallery",i);t._clickHandler=n,t.addEventListener("click",n)})),document.querySelectorAll('[data-media-mode="image"]').forEach((t=>{t._clickHandler&&t.removeEventListener("click",t._clickHandler);const i=t.getAttribute("data-image-id"),n=e("image",i);t._clickHandler=n,t.addEventListener("click",n)})),document.querySelectorAll(".media-button").forEach((t=>{t._clickHandler&&t.removeEventListener("click",t._clickHandler);const i=t.getAttribute("data-media-mode")||"editor",n="gallery"===i?t.getAttribute("data-gallery-id"):"image"===i?t.getAttribute("data-image-id"):null,a=e(i,n);t._clickHandler=a,t.addEventListener("click",a)}))},setupMutationObserver:function(){if(void 0===window.MutationObserver)return void console.warn("MutationObserver no está disponible");this.setupMediaButtons();new window.MutationObserver((e=>{let t=!1;e.forEach((e=>{e.addedNodes.length&&e.addedNodes.forEach((e=>{1===e.nodeType&&(e.hasAttribute("data-media-mode")||e.querySelector("[data-media-mode]")||e.classList.contains("media-button")||e.querySelector(".media-button"))&&(t=!0)}))})),t&&this.setupMediaButtons()})).observe(document.body,{childList:!0,subtree:!0})},openModal:function(e="editor",t=null){if(console.log("openModal llamado con modo:",e,"y ID:",t),!this.modal){if(console.warn("Modal no inicializado, intentando reinicializar..."),this.modal=document.getElementById("media-modal"),!this.modal){console.error("Error: El modal no existe en el DOM");const e=document.querySelector(".media-modal");if(!e)return console.error("No se pudo encontrar el modal en el DOM"),void alert("Error: No se pudo abrir la biblioteca de medios. Por favor, recarga la página.");this.modal=e,console.log("Modal encontrado usando selector alternativo")}this.mediaGrid=this.mediaGrid||document.querySelector(".media-grid"),this.mediaLoading=this.mediaLoading||document.querySelector(".media-loading"),this.closeModalBtn=this.closeModalBtn||document.getElementById("close-media-modal"),this.closeModalBtn&&this.closeModalBtn.addEventListener("click",(()=>{this.closeModal()}))}this.currentMode=e||"editor",console.log("Modo establecido a:",this.currentMode),"gallery"===e?(this.currentGalleryId=t,this.currentImageId=null,console.log("ID de galería establecido a:",this.currentGalleryId)):"image"===e?(this.currentImageId=t,this.currentGalleryId=null,console.log("ID de imagen establecido a:",this.currentImageId)):(this.currentGalleryId=null,this.currentImageId=null,console.log("IDs de galería e imagen restablecidos")),this.selectedImages=[],this.updateModeUI(),this.modal.classList.remove("hidden"),document.body.classList.add("overflow-hidden"),this.loadMedia(this.currentMediaPath||""),document.dispatchEvent(new CustomEvent("mediaModalOpened",{detail:{mode:this.currentMode}}))},closeModal:function(){this.modal&&(this.modal.classList.remove("modal-active"),this.modal.classList.add("hidden"),this.modal.style.display="none"),this.selectedImages=[],this.updateSelectedCount()},updateModeUI:function(){this.modeIndicator&&("editor"===this.currentMode?(this.modeIndicator.textContent="Modo: Insertar en Editor",this.modeIndicator.classList.remove("hidden")):"main-image"===this.currentMode?(this.modeIndicator.textContent="Modo: Imagen Principal",this.modeIndicator.classList.remove("hidden")):"gallery"===this.currentMode?(this.modeIndicator.textContent="Modo: Galería",this.modeIndicator.classList.remove("hidden")):"image"===this.currentMode?(this.modeIndicator.textContent="Modo: Seleccionar Imagen",this.modeIndicator.classList.remove("hidden")):this.modeIndicator.classList.add("hidden")),this.modalFooter&&("gallery"===this.currentMode?this.modalFooter.classList.remove("hidden"):this.modalFooter.classList.add("hidden"))},updateSelectedCount:function(){if(this.selectedCount){const e=this.selectedImages.length;this.selectedCount.textContent=`${e} ${1===e?"imagen seleccionada":"imágenes seleccionadas"}`}this.confirmSelectionBtn&&(this.confirmSelectionBtn.disabled=0===this.selectedImages.length)},loadMedia:function(e=""){if(!this.isLoading){if(this.isLoading=!0,this.currentMediaPath=e,this.mediaGrid&&(this.mediaGrid.innerHTML=""),this.mediaLoading&&this.mediaLoading.classList.remove("hidden"),this.currentPath)if(e){this.currentPath.innerHTML="";const t=e.split("/");this.currentPath.appendChild(document.createTextNode(" / "));let i="";t.forEach(((e,n)=>{i?i+="/"+e:i=e;const a=document.createElement("button");a.className="text-neutral-600 dark:text-neutral-300 hover:underline",a.textContent=e;const s=i;a.addEventListener("click",(()=>{this.loadMedia(s)})),this.currentPath.appendChild(a),n<t.length-1&&this.currentPath.appendChild(document.createTextNode(" / "))}))}else this.currentPath.textContent="";fetch(window.getApiUrl(`?action=media&path=${encodeURIComponent(e)}`),{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}}).then((e=>e.json())).then((t=>{if(this.mediaLoading&&this.mediaLoading.classList.add("hidden"),this.isLoading=!1,!t.success)return void(this.mediaGrid&&(this.mediaGrid.innerHTML=`<div class="col-span-full text-center py-4 text-red-500">${t.message||"Error al cargar medios"}</div>`));const i=t.items?t.items.filter((e=>"directory"===e.type)).map((e=>e.name)):[],n=t.items?t.items.filter((e=>"image"===e.type)).map((e=>e.name)):[];if(0===i.length&&0===n.length)return void(this.mediaGrid&&(this.mediaGrid.innerHTML='<div class="col-span-full text-center py-4 text-neutral-500 dark:text-neutral-400">No se encontraron medios</div>'));const a=document.createDocumentFragment();i.forEach((t=>{const i=document.createElement("div");i.className="directory p-2 border border-neutral-300 dark:border-neutral-700 rounded cursor-pointer hover:bg-neutral-300 dark:hover:bg-neutral-700 relative group",i.innerHTML=`\n            <div class="flex items-center justify-between">\n              <div class="flex items-center">\n                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-neutral-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />\n                </svg>\n                <span class="ml-2 truncate text-neutral-500 dark:text-neutral-300">${t}</span>\n              </div>\n              <button class="delete-dir text-neutral-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity" data-dir="${t}">\n                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">\n                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />\n                </svg>\n              </button>\n            </div>\n          `,i.querySelector(".delete-dir").addEventListener("click",(e=>{e.stopPropagation(),this.deleteDirectory(t)})),i.addEventListener("click",(i=>{if(!i.target.closest(".delete-dir")){const i=e?`${e}/${t}`:t;this.loadMedia(i)}})),a.appendChild(i)}));const s=new window.IntersectionObserver((e=>{e.forEach((e=>{if(e.isIntersecting){const t=e.target,i=t.getAttribute("data-src");i&&(t.src=i,t.removeAttribute("data-src"),t.classList.remove("opacity-0"),t.classList.add("opacity-100"),s.unobserve(t))}}))}),{root:null,rootMargin:"100px",threshold:.1});n.forEach((t=>{const i=document.createElement("div");let n="image-item relative group";this.currentMode,n+=" cursor-pointer",i.className=n;const o=e?`${e}/${t}`:t,r=this.buildImagePath(o,!1),l=this.buildImagePath(o,!0),d=this.selectedImages.some((e=>e.path===l));d&&(i.classList.add("selected-image"),i.classList.add("ring-2"),i.classList.add("ring-red-500"));const c=document.createElement("div");c.className="relative pb-[100%] overflow-hidden bg-neutral-200 dark:bg-neutral-800 rounded border border-neutral-300 dark:border-neutral-700";const m=document.createElement("img");m.className="absolute inset-0 w-full h-full object-cover transition-opacity duration-300 opacity-0",m.src='data:image/svg+xml;charset=UTF-8,%3Csvg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"%3E%3Crect width="40" height="40" fill="%23f0f0f0"/%3E%3Ctext x="50%25" y="50%25" font-size="5" text-anchor="middle" alignment-baseline="middle" font-family="sans-serif" fill="%23999"%3ELoading...%3C/text%3E%3C/svg%3E',m.setAttribute("data-src",r),m.alt=t,c.appendChild(m);const u=document.createElement("div");u.className="mt-1 text-xs truncate text-neutral-600 dark:text-neutral-400",u.textContent=t;const h=document.createElement("div");h.className="absolute top-1 right-1 invisible group-hover:visible flex space-x-1";const g=document.createElement("button");g.className="delete-image bg-red-500 hover:bg-red-700 text-white rounded-full p-1",g.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>',h.appendChild(g),i.appendChild(c),i.appendChild(u),i.appendChild(h),"gallery"===this.currentMode?i.addEventListener("click",(()=>{this.toggleImageSelection(t,l,r,i)})):i.addEventListener("click",(e=>{e.target.closest(".delete-image")||this.handleImageSelection(t,l,r)})),g.addEventListener("click",(e=>{e.stopPropagation(),this.deleteImage(t)})),a.appendChild(i),s.observe(m)})),this.mediaGrid&&this.mediaGrid.appendChild(a)})).catch((e=>{this.mediaLoading&&this.mediaLoading.classList.add("hidden"),this.isLoading=!1,this.mediaGrid&&(this.mediaGrid.innerHTML='<div class="col-span-full text-center py-4 text-red-500">Error al cargar medios: '+e.message+"</div>")}))}},handleImageSelection:function(e,t,i){const n=this.buildImagePath(t,!0),a=this.buildImagePath(t,!1);if("editor"===this.currentMode)this.insertImageToEditor(e,n),this.closeModal();else if("main-image"===this.currentMode)this.setMainImage(e,n,i),this.closeModal();else if("image"===this.currentMode)this.setImage(e,n,i);else if("gallery"===this.currentMode){const n=this.mediaGrid.querySelectorAll(".image-item");let s=null;for(const e of n){const t=e.querySelector("img[data-src]");if(t&&t.getAttribute("data-src")===a){s=e;break}}if(!s)for(const t of n){const i=t.querySelector("img");if(i&&(i.src.endsWith(a)||i.src.endsWith(e))){s=t;break}}s&&this.toggleImageSelection(e,t,i,s)}},toggleImageSelection:function(e,t,i,n){const a=this.selectedImages.findIndex((e=>e.path===t));if(-1!==a){this.selectedImages.splice(a,1),n.classList.remove("selected-image","ring-2","ring-red-500");const e=n.querySelector(".absolute > div");e&&(e.innerHTML="",e.parentElement.classList.add("opacity-0"),e.parentElement.classList.remove("opacity-100"))}else{const i=this.buildImagePath(t,!1);let a=t;if(a.startsWith("/img/"))console.log("Ruta ya tiene formato correcto para front-matter (galería):",a);else if(a.includes("../../../public/img/"))a=a.replace("../../../public/img/","/img/");else if(a.includes("../../public/img/"))a=a.replace("../../public/img/","/img/"),console.log("Ruta convertida a formato correcto para front-matter (galería):",a);else{const e=a.replace(/^(\.\.\/)*/g,"");a="/img/"+e.replace(/^public\/img\//i,"").replace(/^\/+/,""),console.log("Ruta normalizada para front-matter (galería):",a)}document.dispatchEvent(new CustomEvent("mainImageSelected",{detail:{name:e,path:a,fullPath:i,forMainImage:!0}})),this.selectedImages.push({name:e,path:a,fullPath:i}),n.classList.add("selected-image","ring-2","ring-red-500");const s=n.querySelector(".absolute > div");s&&(s.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>',s.parentElement.classList.remove("opacity-0"),s.parentElement.classList.add("opacity-100"))}this.updateSelectedCount()},deleteImage:function(e){if(window.confirm("¿Estás seguro de que deseas eliminar esta imagen?")){this.mediaLoading.classList.remove("hidden"),this.mediaGrid.classList.add("hidden");const t=this.currentMediaPath||"";fetch(window.getApiUrl("?action=deleteimage"),{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},body:`image=${encodeURIComponent(e)}&path=${encodeURIComponent(t)}`}).then((e=>e.json())).then((t=>{if(this.mediaLoading&&this.mediaLoading.classList.add("hidden"),this.isLoading=!1,t.success){this.mediaGrid.classList.remove("hidden");this.mediaGrid.querySelectorAll(".image-item").forEach((t=>{const i=t.querySelector(".truncate");i&&i.textContent.trim()===e&&(t.style.transition="opacity 0.3s ease",t.style.opacity="0",setTimeout((()=>{t.remove(),0===this.mediaGrid.querySelectorAll(".image-item").length&&0===this.mediaGrid.querySelectorAll(".directory").length&&(this.mediaGrid.innerHTML='<div class="col-span-full text-center py-4 text-neutral-500 dark:text-neutral-400">No se encontraron medios</div>')}),300))})),this.showFlashMessage("Imagen movida a la papelera de reciclaje","success")}else window.alert("Error al mover la imagen a la papelera: "+(t.message||t.error))})).catch((e=>{console.error("Error al mover la imagen a la papelera:",e),window.alert("Error al mover la imagen a la papelera"),this.mediaLoading.classList.add("hidden"),this.mediaGrid.classList.remove("hidden")}))}},confirmGallerySelection:function(){if(0===this.selectedImages.length)return;const e=document.querySelector(`.gallery-field[data-gallery-id="${this.currentGalleryId}"]`);if(!e)return;const t=e.querySelector(".gallery-images-container"),i=e.querySelector(".gallery-data");if(!t||!i)return;t.innerHTML="";const n=this.selectedImages.map((e=>{const t=e.path;if(t.startsWith("/img/"))return t;if(t.includes("../../../public/img/"))return t.replace("../../../public/img/","/img/");if(t.includes("../../public/img/"))return t.replace("../../public/img/","/img/");return"/img/"+t.replace(/^(\.\.\/)*/,"").replace(/^public\/img\//i,"").replace(/^\/+/,"")}));i.value=JSON.stringify(n),this.selectedImages.forEach((e=>{const n=document.createElement("div");n.className="gallery-image-item relative border border-neutral-300 dark:border-neutral-700 rounded overflow-hidden";let a="";a=e.fullPath.startsWith("/")?`../../../public${e.fullPath}`:e.fullPath.includes("public/img")?e.fullPath.replace(/^\.\.\/\.\.\/public\//,"../../../public/"):`../../../public/${e.fullPath}`,n.innerHTML=`\n        <img src="${a}" class="w-full h-20 object-cover">\n        <button type="button" class="gallery-remove-image absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center" data-path="${e.path}">\n          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">\n            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />\n          </svg>\n        </button>\n      `;const s=n.querySelector(".gallery-remove-image");s&&s.addEventListener("click",(()=>{n.remove();const t=JSON.parse(i.value||"[]").filter((t=>t!==e.path));i.value=JSON.stringify(t)})),t.appendChild(n)})),this.closeModal()},insertImageToEditor:function(e,t){if(!window.editor)return;let i=t;if(i.startsWith("/img/"))console.log("Ruta ya tiene formato correcto:",i);else if(i.includes("../../../public/img/"))i=i.replace("../../../public/img/","/img/");else if(i.includes("../../public/img/"))i=i.replace("../../public/img/","/img/"),console.log("Ruta convertida a formato correcto:",i);else{const e=i.replace(/^(\.\.\/)+/g,"");i="/img/"+e.replace(/^public\/img\//i,"").replace(/^\/+/,""),console.log("Ruta normalizada:",i)}const n=`![${e}](${i})`;console.log("Insertando imagen con ruta:",i),window.editor.codemirror.replaceSelection(n),this.showFlashMessage("Imagen insertada en el editor")},setMainImage:function(e,t,i){const n=document.getElementById("main-image-path"),a=document.getElementById("main-image-preview"),s=document.getElementById("main-image-placeholder"),o=document.querySelector(".main-image-status"),r=this.buildImagePath(t,!1);let l=t;if(l.startsWith("/img/"))console.log("Ruta ya tiene formato correcto para front-matter:",l);else if(l.includes("../../../public/img/"))l=l.replace("../../../public/img/","/img/");else if(l.includes("../../public/img/"))l=l.replace("../../public/img/","/img/"),console.log("Ruta convertida a formato correcto para front-matter:",l);else{const e=l.replace(/^(\.\.\/)*/,"");l="/img/"+e.replace(/^public\/img\//i,"").replace(/^\/+/,""),console.log("Ruta normalizada para front-matter:",l)}n&&(n.value=l),o&&(o.textContent="Imagen seleccionada"),a&&s&&(a.src=r,a.classList.remove("hidden"),s.classList.add("hidden")),document.dispatchEvent(new CustomEvent("mainImageSelected",{detail:{name:e,path:l,fullPath:r,forMainImage:!0}})),this.showFlashMessage("Imagen principal establecida")},setImage:function(e,t,i){const n=this.buildImagePath(t,!1);let a=t;if(a.startsWith("/img/"));else if(a.includes("../../../public/img/"))a=a.replace("../../../public/img/","/img/");else if(a.includes("../../public/img/"))a=a.replace("../../public/img/","/img/");else{const e=a.replace(/^(\.\.\/)*/,"");a="/img/"+e.replace(/^public\/img\//i,"").replace(/^\/+/,"")}const s=document.querySelector(`.image-field[data-image-id="${this.currentImageId}"]`);if(!s)return void console.error("No se encontró el campo de imagen con ID:",this.currentImageId);const o=s.querySelector(".image-container"),r=s.querySelector(".image-data");if(!o||!r)return void console.error("No se encontraron los elementos necesarios para el campo de imagen");o.innerHTML="",r.value=a;const l=document.createElement("div");l.className="image-preview-wrapper",l.innerHTML=`\n      <img src="${n}">\n      <button type="button" class="image-remove" data-path="${a}">\n        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">\n          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />\n        </svg>\n      </button>\n    `,o.appendChild(l);const d=s.querySelector(".image-select");d&&(d.textContent="Change Image"),this.showFlashMessage(`Imagen seleccionada: ${e}`,"success"),this.closeModal()},showFlashMessage:function(e,t="success"){const i=document.createElement("div");i.className="flash-message","success"===t?i.classList.add("bg-green-500","text-white"):"error"===t?i.classList.add("bg-red-500","text-white"):"warning"===t?i.classList.add("bg-yellow-500","text-white"):i.classList.add("bg-blue-500","text-white"),i.textContent=e,document.body.appendChild(i),setTimeout((()=>{i.classList.add("active")}),10),setTimeout((()=>{i.classList.remove("active"),setTimeout((()=>{document.body.removeChild(i)}),500)}),1500)},createDirectoryModal:function(){if(document.getElementById("create-dir-modal"))return;const e=document.createElement("div");e.id="create-dir-modal",e.className="fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center hidden",e.style.display="none",e.innerHTML='\n      <div class="bg-white dark:bg-neutral-900 rounded-lg shadow-xl w-96 p-6">\n        <h3 class="text-lg font-semibold mb-4">Crear Nueva Carpeta</h3>\n        <div class="mb-4">\n          <label for="dir-name" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">Nombre de la carpeta</label>\n          <input type="text" id="dir-name" class="w-full px-3 py-2 border border-neutral-300 dark:border-neutral-700 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500 dark:bg-neutral-800">\n        </div>\n        <div class="flex justify-end gap-2">\n          <button id="cancel-create-dir" class="px-4 py-2 bg-neutral-300 dark:bg-neutral-700 text-neutral-700 dark:text-neutral-300 rounded hover:bg-neutral-400 dark:hover:bg-neutral-600">\n            Cancelar\n          </button>\n          <button id="confirm-create-dir" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">\n            Crear\n          </button>\n        </div>\n      </div>\n    ',document.body.appendChild(e);const t=document.getElementById("cancel-create-dir"),i=document.getElementById("confirm-create-dir"),n=document.getElementById("dir-name");t.addEventListener("click",(()=>{e.classList.add("hidden"),e.style.display="none",n.value=""})),i.addEventListener("click",(()=>{const t=n.value.trim();t&&(this.createDirectory(t),e.classList.add("hidden"),e.style.display="none",n.value="")})),this.createDirModal=e},showCreateDirectoryModal:function(){this.createDirModal&&(this.createDirModal.classList.remove("hidden"),this.createDirModal.style.display="flex",document.getElementById("dir-name").focus())},createDirectory:function(e){this.mediaLoading.classList.remove("hidden"),this.mediaGrid.classList.add("hidden");const t=this.currentMediaPath||"",i=window.API_BASE_PATH||"process.php",n=window.CURRENT_COLLECTION||"",a=`${i}?action=createdir&collection=${encodeURIComponent(n)}`;console.log("Creating directory using URL:",a),fetch(a,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},body:`dirname=${encodeURIComponent(e)}&path=${encodeURIComponent(t)}`}).then((e=>e.json())).then((e=>{if(!e.success)throw this.showFlashMessage("Error al crear directorio: "+e.error,"error"),this.mediaLoading.classList.add("hidden"),this.mediaGrid.classList.remove("hidden"),new Error("Error al crear directorio: "+e.error);this.loadMedia(this.currentMediaPath),setTimeout((()=>{this.mediaLoading.classList.add("hidden"),this.mediaGrid.classList.remove("hidden")}),500),this.showFlashMessage("Directorio creado correctamente","success")})).catch((e=>{window.alert("Error al crear directorio"),this.mediaLoading.classList.add("hidden"),this.mediaGrid.classList.remove("hidden")}))},deleteDirectory:function(e){if(!window.confirm(`¿Estás seguro de que deseas eliminar el directorio "${e}" y todo su contenido?`))return;this.mediaLoading.classList.remove("hidden"),this.mediaGrid.classList.add("hidden");const t=this.currentMediaPath||"",i=t?`${t}/${e}`:e;fetch(window.getApiUrl("?action=deletedir"),{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},body:`fullpath=${encodeURIComponent(i)}`}).then((e=>e.json())).then((e=>{this.mediaLoading&&this.mediaLoading.classList.add("hidden"),this.isLoading=!1,e.success?(this.loadMedia(this.currentMediaPath),setTimeout((()=>{this.mediaLoading.classList.add("hidden"),this.mediaGrid.classList.remove("hidden")}),500),this.showFlashMessage("Directorio eliminado correctamente","success")):(window.alert("Error al eliminar directorio: "+e.message),this.mediaLoading.classList.add("hidden"),this.mediaGrid.classList.remove("hidden"))})).catch((e=>{console.error("Error al eliminar directorio:",e),window.alert("Error al eliminar directorio"),this.mediaLoading.classList.add("hidden"),this.mediaGrid.classList.remove("hidden")}))},uploadImage:function(e){if(!e||0===e.length)return;this.mediaLoading.classList.remove("hidden"),this.mediaGrid.classList.add("hidden");const t=new FormData;t.append("image",e[0]),this.currentMediaPath&&t.append("path",this.currentMediaPath);const i=window.API_BASE_PATH||"process.php",n=window.CURRENT_COLLECTION||"",a=`${i}?action=upload&collection=${encodeURIComponent(n)}`;console.log("Uploading image to URL:",a);const s={method:"POST",credentials:"include",mode:"cors",headers:{"X-Requested-With":"XMLHttpRequest"},body:t};console.log("Fetch options:",JSON.stringify(s,((e,t)=>"body"===e&&t instanceof FormData?"[FormData]":t),2)),fetch(a,s).then((e=>e.json())).then((e=>{if(!e.success)throw this.showFlashMessage("Error al subir imagen: "+e.message,"error"),this.mediaLoading.classList.add("hidden"),this.mediaGrid.classList.remove("hidden"),new Error("Error al subir imagen: "+e.message);this.loadMedia(this.currentMediaPath),setTimeout((()=>{this.mediaLoading.classList.add("hidden"),this.mediaGrid.classList.remove("hidden")}),500),this.showFlashMessage("Imagen subida correctamente","success")})).catch((e=>{window.alert("Error al subir imagen"),this.mediaLoading.classList.add("hidden"),this.mediaGrid.classList.remove("hidden")})),this.uploadInput.value=""}}},function(e,t,i){i.r(t),i.d(t,{MainImageManager:function(){return n},mainImageManager:function(){return a}});class n{constructor(){this.paths={root:window.PATHS?window.PATHS.ROOT:"/",cms:window.PATHS?window.PATHS.CMS:"/content/",media:window.PATHS?window.PATHS.MEDIA:"../../../public/img"},this.mainImageSection=document.querySelector(".main-image-section"),this.mainImageStatus=document.querySelector(".main-image-status"),this.mainImagePreview=document.getElementById("main-image-preview"),this.mainImagePlaceholder=document.getElementById("main-image-placeholder"),this.mainImagePath=document.getElementById("main-image-path"),this.selectMainImageBtn=document.getElementById("select-main-image"),this.clearMainImageBtn=document.getElementById("clear-main-image"),this.selectingForMainImage=!1,this.init()}init(){if(this.mainImageSection){if(!this.selectMainImageBtn&&(this.selectMainImageBtn=document.getElementById("select-main-image"),!this.selectMainImageBtn)){document.querySelectorAll("button").forEach(((e,t)=>{}))}this.setupEventListeners()}}setupEventListeners(){this.selectMainImageBtn?(this.selectMainImageBtn.removeEventListener("click",this.showMediaSelectionModal.bind(this)),this.selectMainImageBtn.addEventListener("click",(e=>{this.showMediaSelectionModal()})),this.selectMainImageBtn.onclick=e=>{}):setTimeout((()=>{this.selectMainImageBtn=document.getElementById("select-main-image"),this.clearMainImageBtn=document.getElementById("clear-main-image"),this.selectMainImageBtn&&this.selectMainImageBtn.addEventListener("click",(e=>{this.showMediaSelectionModal()}))}),1e3),this.clearMainImageBtn&&(this.clearMainImageBtn.removeEventListener("click",this.clearMainImage.bind(this)),this.clearMainImageBtn.addEventListener("click",(e=>{this.clearMainImage()}))),document.removeEventListener("mediaSelected",this.handleMediaSelection.bind(this)),document.addEventListener("mediaSelected",(e=>{this.handleMediaSelection(e)})),this.setupMutationObserver()}setupMutationObserver(){const e=new MutationObserver((t=>{t.forEach((t=>{t.addedNodes.length&&t.addedNodes.forEach((t=>{1===t.nodeType&&("select-main-image"===t.id||t.querySelector("#select-main-image"))&&(this.selectMainImageBtn=document.getElementById("select-main-image"),this.selectMainImageBtn&&(this.selectMainImageBtn.addEventListener("click",(e=>{this.showMediaSelectionModal()})),e.disconnect()))}))}))}));e.observe(document.body,{childList:!0,subtree:!0})}showMediaSelectionModal(){this.selectingForMainImage=!0,window.selectingMainImage=!0,window.Media&&"function"==typeof window.Media.insertImageToEditor&&this.overrideMediaFunctions(),document.dispatchEvent(new CustomEvent("selectForMainImage",{detail:{active:!0}}))}setupGlobalImageClickListener(){document.removeEventListener("click",this._globalImageClickHandler),this._globalImageClickHandler=e=>{if(!this.selectingForMainImage)return;const t=e.target.closest(".image-item"),i=e.target.closest(".insert-image");if(t||i){e.preventDefault(),e.stopPropagation();const n=(t||i.closest(".image-item")).querySelector("img");if(!n)return;const a=n.getAttribute("src"),s=n.getAttribute("alt"),o=a.replace("../../../public","");return this.setMainImage(s,o,a),this.selectingForMainImage=!1,window.Media&&(window.Media.selectingForMainImage=!1),!1}},document.addEventListener("click",this._globalImageClickHandler,!0)}addVisualIndicatorsToImages(){document.querySelectorAll(".image-item").forEach((e=>{if(!e.hasAttribute("data-selecting-indicator")){e.setAttribute("data-selecting-indicator","true"),e.style.border="2px solid red",e.style.position="relative";const t=document.createElement("div");t.className="absolute top-0 right-0 bg-red-500 text-white text-xs px-1 py-0.5 rounded-bl",t.textContent="Click para seleccionar",e.appendChild(t)}}))}removeVisualIndicatorsFromImages(){document.querySelectorAll(".image-item[data-selecting-indicator]").forEach((e=>{e.removeAttribute("data-selecting-indicator"),e.style.border="";const t=e.querySelector(".absolute");t&&t.remove()}))}removeSelectionIndicator(){const e=document.querySelector(".selecting-for-main-image");e&&e.classList.remove("selecting-for-main-image");const t=document.querySelector(".selecting-indicator");t&&t.parentNode&&t.parentNode.removeChild(t)}overrideMediaFunctions(){if(window.Media)this._overrideMediaDirectly(window.Media);else{this._findAndOverrideMedia();const e=setInterval((()=>{window.Media&&(this._overrideMediaDirectly(window.Media),clearInterval(e))}),500);setTimeout((()=>{clearInterval(e)}),1e4)}}_overrideMediaDirectly(e){const t=e.insertImageToEditor,i=this;e.insertImageToEditor=function(e,n){return i.selectingForMainImage||this.selectingForMainImage||window.selectingMainImage?(i.setMainImage(e,n,n),i.selectingForMainImage=!1,this.selectingForMainImage=!1,void(window.selectingMainImage=!1)):t.call(this,e,n)}}_findAndOverrideMedia(){document.querySelectorAll('script[src*="media"]');for(const e in window)try{const t=window[e];if(t&&"object"==typeof t&&t.insertImageToEditor)return void this._overrideMediaDirectly(t)}catch(e){}"complete"!==document.readyState&&"interactive"!==document.readyState&&document.addEventListener("DOMContentLoaded",(()=>{window.Media&&this._overrideMediaDirectly(window.Media)}))}handleMediaSelection(e){if(e.detail&&e.detail.forMainImage){const t=e.detail.path,i=e.detail.fullPath;this.setMainImage(e.detail.name,t,i)}}setMainImage(e,t,i){let n=t;n&&!n.startsWith("/")&&(n="/"+n),this.mainImagePath&&(this.mainImagePath.value=n),this.mainImageStatus&&(this.mainImageStatus.textContent="Image selected"),this.mainImagePreview&&this.mainImagePlaceholder&&(this.mainImagePreview.src=i,this.mainImagePreview.classList.remove("hidden"),this.mainImagePlaceholder.classList.add("hidden")),this.removeSelectionIndicator(),this.removeVisualIndicatorsFromImages(),this.selectingForMainImage=!1,this.closeMediaModal(),this.mainImageSection&&setTimeout((()=>{this.mainImageSection.scrollIntoView({behavior:"smooth"})}),300);const a=new CustomEvent("mainImageSelected",{detail:{name:e,path:this.mainImagePath?this.mainImagePath.value:t,fullPath:i}});document.dispatchEvent(a)}closeMediaModal(){if(window.MediaManager&&"function"==typeof window.MediaManager.closeModal)window.MediaManager.closeModal();else if(window.Media&&"function"==typeof window.Media.closeModal)window.Media.closeModal();else{const e=document.getElementById("media-modal");e&&(e.classList.add("hidden"),e.style.display="none");const t=document.getElementById("close-media-modal");t&&t.click()}}clearMainImage(){this.mainImagePath&&(this.mainImagePath.value=""),this.mainImageStatus&&(this.mainImageStatus.textContent="No image selected"),this.mainImagePreview&&this.mainImagePreview.classList.add("hidden"),this.mainImagePlaceholder&&this.mainImagePlaceholder.classList.remove("hidden")}}const a=new n},function(e,t,i){i.r(t),i.d(t,{RecycleBinManager:function(){return n}});const n={paths:{root:window.PATHS?window.PATHS.ROOT:"/",cms:window.PATHS?window.PATHS.CMS:"/content/",media:window.PATHS?window.PATHS.MEDIA:"../../../public/img"},modal:null,closeBtn:null,openBtn:null,tabFiles:null,tabImages:null,filesGrid:null,imagesGrid:null,loadingIndicator:null,emptyState:null,itemCount:null,emptyRecycleBinBtn:null,currentTab:"files",isConfirmingEmpty:!1,init:function(e=0){this.modal=document.getElementById("recycle-bin-modal"),this.closeBtn=document.getElementById("close-recycle-bin"),this.openBtn=document.getElementById("open-recycle-bin"),this.tabFiles=document.getElementById("tab-files"),this.tabImages=document.getElementById("tab-images"),this.filesGrid=document.getElementById("recycle-files-grid"),this.imagesGrid=document.getElementById("recycle-images-grid"),this.loadingIndicator=document.getElementById("recycle-loading"),this.emptyState=document.getElementById("recycle-empty"),this.itemCount=document.getElementById("recycle-count"),this.emptyRecycleBinBtn=document.getElementById("empty-recycle-bin"),this.modal&&this.openBtn?this.setupEventListeners():e<3&&setTimeout((()=>this.init(e+1)),1e3)},setupEventListeners:function(){this.openBtn&&this.openBtn.addEventListener("click",(()=>this.openModal())),this.closeBtn&&this.closeBtn.addEventListener("click",(()=>this.closeModal())),this.tabFiles&&this.tabFiles.addEventListener("click",(()=>this.switchTab("files"))),this.tabImages&&this.tabImages.addEventListener("click",(()=>this.switchTab("images"))),this.emptyRecycleBinBtn&&this.emptyRecycleBinBtn.addEventListener("click",(()=>this.confirmEmptyRecycleBin()))},openModal:function(){this.modal&&(this.modal.style.display="flex",setTimeout((()=>{this.modal.classList.remove("hidden")}),10),this.loadRecycleBinItems())},closeModal:function(){this.modal&&(this.modal.classList.add("hidden"),setTimeout((()=>{if(this.modal.style.display="none",window.FileManager&&"function"==typeof window.FileManager.loadFileList)window.FileManager.loadFileList();else if(window.App&&window.App.FileManager&&"function"==typeof window.App.FileManager.loadFileList)window.App.FileManager.loadFileList();else{const e=new CustomEvent("refreshFileList");document.dispatchEvent(e)}}),300))},switchTab:function(e){e!==this.currentTab&&(this.currentTab=e,this.tabFiles&&this.tabImages&&("files"===e?(this.tabFiles.classList.add("border-red-500","text-red-500"),this.tabFiles.classList.remove("border-transparent","hover:text-red-500"),this.tabImages.classList.remove("border-red-500","text-red-500"),this.tabImages.classList.add("border-transparent","hover:text-red-500")):(this.tabImages.classList.add("border-red-500","text-red-500"),this.tabImages.classList.remove("border-transparent","hover:text-red-500"),this.tabFiles.classList.remove("border-red-500","text-red-500"),this.tabFiles.classList.add("border-transparent","hover:text-red-500"))),this.filesGrid&&this.imagesGrid&&("files"===e?(this.filesGrid.classList.remove("hidden"),this.imagesGrid.classList.add("hidden")):(this.filesGrid.classList.add("hidden"),this.imagesGrid.classList.remove("hidden"))),this.loadRecycleBinItems())},loadRecycleBinItems:function(){this.loadingIndicator.classList.remove("hidden"),this.filesGrid.classList.add("hidden"),this.imagesGrid.classList.add("hidden"),this.emptyState.classList.add("hidden");const e=this.currentTab,t=window.currentCollection||"";fetch(window.getApiUrl(`?action=recyclebin&type=${e}&collection=${encodeURIComponent(t)}`)).then((e=>e.json())).then((t=>{if(this.loadingIndicator.classList.add("hidden"),t.success){const i=t.files||[];if(this.itemCount.textContent=i.length+(1===i.length?" item":" items"),0===i.length)return this.emptyState.classList.remove("hidden"),void("files"===e?this.filesGrid.classList.add("hidden"):this.imagesGrid.classList.add("hidden"));"files"===e?(this.renderFiles(i),this.filesGrid.classList.remove("hidden")):(this.renderImages(i),this.imagesGrid.classList.remove("hidden"))}else this.showFlashMessage("Error al cargar elementos de la papelera","error")})).catch((e=>{this.showFlashMessage("Error al cargar elementos de la papelera","error"),this.loadingIndicator.classList.add("hidden")}))},renderFiles:function(e){this.filesGrid.innerHTML="",e.forEach((e=>{const t=document.createElement("div");t.className="trash-item";const i=document.createElement("div");i.className="font-medium mb-2 truncate",i.textContent=e.original_name||e.name;const n=document.createElement("div");n.className="text-sm text-neutral-500 dark:text-neutral-400 mb-3";let a="Desconocido";if(e.deleted_at)try{a=new Date(e.deleted_at).toLocaleString()}catch(t){a=e.deleted_at}n.textContent=`Eliminado: ${a}`;const s=document.createElement("div");s.className="flex justify-end mt-auto space-x-2";const o=document.createElement("button");o.className="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 transition",o.textContent="Restaurar",o.addEventListener("click",(()=>this.restoreFile(e.name)));const r=document.createElement("button");r.className="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition",r.textContent="Eliminar",r.addEventListener("click",(()=>this.permanentlyDeleteFile(e.name))),s.appendChild(o),s.appendChild(r),t.appendChild(i),t.appendChild(n),t.appendChild(s),this.filesGrid.appendChild(t)}))},getCollectionFromUrl:function(){try{const e=window.location.pathname.split("?")[0].split("#")[0].split("/").filter((e=>""!==e.trim())),t=e.indexOf("collections");if(-1!==t&&t+1<e.length)return e[t+1];const i=e[e.length-1];if(i&&i.includes(".")){if(e.length>1)return e[e.length-2]}else if(e.length>0)return i;const n=document.querySelector("[data-collection]");if(n&&n.dataset.collection)return n.dataset.collection}catch(e){console.error("Error al obtener la colección de la URL:",e)}return window.currentCollection||"blog"},normalizeUrl:function(e){if(!e)return e;const t=this.getCollectionFromUrl();if(e.includes(`/collections/${t}/recycle/images/`))return e;if(e.includes("/recycle/images/")){const i=e.split("/recycle/images/")[1]||"";e=`/content/collections/${t}/recycle/images/${i}`}return e=e.replace(/([^:])\/{2,}/g,"$1/")},renderImages:function(e){this.imagesGrid.innerHTML="",e.forEach((e=>{const t=document.createElement("div");t.className="trash-image";const i=document.createElement("div");if(i.className="h-32 bg-neutral-100 dark:bg-neutral-700 flex items-center justify-center overflow-hidden",e.preview_url){const t=document.createElement("img");t.src=this.normalizeUrl(e.preview_url),t.className="max-h-full max-w-full object-contain",t.onerror=function(){i.innerHTML='\n            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-neutral-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />\n            </svg>\n          '},i.appendChild(t)}else i.innerHTML='\n          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-neutral-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />\n          </svg>\n        ';const n=document.createElement("div");n.className="p-3";const a=document.createElement("div");a.className="font-medium truncate",a.textContent=e.original_name||e.name;let s="";if(e.path){s=this.normalizeUrl(e.path);const t=document.createElement("div");t.className="text-xs text-neutral-400 dark:text-neutral-500 mt-1 truncate",t.textContent=`Ruta: ${s}`,n.appendChild(t)}let o="Desconocido";if(e.deleted_at)try{o=new Date(e.deleted_at).toLocaleString()}catch(t){o=e.deleted_at}const r=document.createElement("div");r.className="text-xs text-neutral-500 dark:text-neutral-400 mt-1",r.textContent=`Eliminado: ${o}`;const l=document.createElement("div");l.className="flex justify-between mt-2 space-x-2";const d=document.createElement("button");d.className="bg-green-500 text-white px-2 py-1 rounded text-xs flex-1 hover:bg-green-600 transition",d.textContent="Restaurar",d.addEventListener("click",(()=>this.restoreImage(e.name,s||"")));const c=document.createElement("button");c.className="bg-red-500 text-white px-2 py-1 rounded text-xs flex-1 hover:bg-red-600 transition",c.textContent="Eliminar",c.addEventListener("click",(()=>this.permanentlyDeleteImage(e.name,s||""))),l.appendChild(d),l.appendChild(c),n.appendChild(a),n.appendChild(r),n.appendChild(l),t.appendChild(i),t.appendChild(n),this.imagesGrid.appendChild(t)}))},restoreFile:function(e){if(!confirm(`¿Estás seguro de que deseas restaurar "${e}"?`))return;this.loadingIndicator.classList.remove("hidden"),this.filesGrid.classList.add("hidden");const t=window.currentCollection||"";fetch(window.getApiUrl("?action=restore"),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`filename=${encodeURIComponent(e)}&collection=${encodeURIComponent(t)}`}).then((e=>e.json())).then((t=>{this.loadingIndicator.classList.add("hidden"),this.filesGrid.classList.remove("hidden"),t.success?(this.loadRecycleBinItems(),this.showFlashMessage(`Archivo "${e}" restaurado correctamente`,"success")):this.showFlashMessage("Error al restaurar archivo: "+(t.message||t.error),"error")})).catch((e=>{this.showFlashMessage("Error al restaurar archivo","error"),this.loadingIndicator.classList.add("hidden"),this.filesGrid.classList.remove("hidden")}))},permanentlyDeleteFile:function(e){confirm(`¿Estás seguro de que deseas eliminar PERMANENTEMENTE "${e}"? Esta acción no se puede deshacer.`)&&(this.loadingIndicator.classList.remove("hidden"),this.filesGrid.classList.add("hidden"),fetch(window.getApiUrl("?action=permanentdelete"),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`filename=${encodeURIComponent(e)}`}).then((e=>e.json())).then((t=>{this.loadingIndicator.classList.add("hidden"),this.filesGrid.classList.remove("hidden"),t.success?(this.loadRecycleBinItems(),this.showFlashMessage(`Archivo "${e}" eliminado permanentemente`,"success")):this.showFlashMessage("Error al eliminar archivo: "+(t.message||t.error),"error")})).catch((e=>{this.showFlashMessage("Error al eliminar archivo","error"),this.loadingIndicator.classList.add("hidden"),this.filesGrid.classList.remove("hidden")})))},restoreImage:function(e,t=""){if(!confirm(`¿Estás seguro de que deseas restaurar "${e}"?`))return;this.loadingIndicator.classList.remove("hidden"),this.imagesGrid.classList.add("hidden");const i=window.currentCollection||"";fetch(window.getApiUrl("?action=restoreimage"),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`imagename=${encodeURIComponent(e)}&collection=${encodeURIComponent(i)}&path=${encodeURIComponent(t)}`}).then((e=>e.json())).then((t=>{this.loadingIndicator.classList.add("hidden"),this.imagesGrid.classList.remove("hidden"),t.success?(this.loadRecycleBinItems(),this.showFlashMessage(`Imagen "${e}" restaurada correctamente`,"success")):this.showFlashMessage("Error al restaurar imagen: "+(t.message||t.error),"error")})).catch((e=>{this.showFlashMessage("Error al restaurar imagen","error"),this.loadingIndicator.classList.add("hidden"),this.imagesGrid.classList.remove("hidden")}))},permanentlyDeleteImage:function(e,t=""){if(!confirm(`¿Estás seguro de que deseas eliminar PERMANENTEMENTE "${e}"? Esta acción no se puede deshacer.`))return;this.loadingIndicator.classList.remove("hidden"),this.imagesGrid.classList.add("hidden");const i=window.currentCollection||"";fetch(window.getApiUrl("?action=permanentdeleteimage"),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`imagename=${encodeURIComponent(e)}&collection=${encodeURIComponent(i)}&path=${encodeURIComponent(t)}`}).then((e=>e.json())).then((t=>{this.loadingIndicator.classList.add("hidden"),this.imagesGrid.classList.remove("hidden"),t.success?(this.loadRecycleBinItems(),this.showFlashMessage(`Imagen "${e}" eliminada permanentemente`,"success")):this.showFlashMessage("Error al eliminar imagen: "+(t.message||t.error),"error")})).catch((e=>{this.showFlashMessage("Error al eliminar imagen","error"),this.loadingIndicator.classList.add("hidden"),this.imagesGrid.classList.remove("hidden")}))},confirmEmptyRecycleBin:function(){if(!this.isConfirmingEmpty){this.isConfirmingEmpty=!0;try{const e="files"===this.currentTab?"archivos":"imágenes",t=confirm(`¿Deseas vaciar toda la papelera de reciclaje (archivos e imágenes)?\n\n- Presiona "Aceptar" para vaciar TODA la papelera\n- Presiona "Cancelar" para vaciar solo ${e}`);if(null===t)return;const i=t?"all":this.currentTab,n="all"===i?"toda la papelera":"files"===i?"archivos":"imágenes";if(!confirm(`ADVERTENCIA: ¿Estás seguro de que deseas vaciar ${n}?\n\nEsta acción eliminará PERMANENTEMENTE todos los elementos y NO SE PUEDE DESHACER.`))return;this.loadingIndicator.classList.remove("hidden"),this.filesGrid.classList.add("hidden"),this.imagesGrid.classList.add("hidden");const a=window.currentCollection||"";fetch(window.getApiUrl("?action=emptyrecyclebin"),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`type=${encodeURIComponent(i)}&collection=${encodeURIComponent(a)}`}).then((e=>e.json())).then((e=>{this.loadingIndicator.classList.add("hidden"),this.filesGrid.classList.remove("hidden"),this.imagesGrid.classList.remove("hidden"),e.success?("all"!==i&&"files"!==i||(this.filesGrid.innerHTML='<div class="col-span-full text-center py-4 text-neutral-500 dark:text-neutral-400">No hay archivos en la papelera</div>'),"all"!==i&&"images"!==i||(this.imagesGrid.innerHTML='<div class="col-span-full text-center py-4 text-neutral-500 dark:text-neutral-400">No hay imágenes en la papelera</div>'),this.itemCount.textContent="0 items",this.showFlashMessage(`${n} vaciada correctamente`,"success"),"all"===i&&this.switchTab(this.currentTab)):this.showFlashMessage(`Error al vaciar ${n}: ${e.message||e.error}`,"error")})).catch((e=>{this.showFlashMessage(`Error al vaciar ${n}`,"error"),this.loadingIndicator.classList.add("hidden"),this.filesGrid.classList.remove("hidden"),this.imagesGrid.classList.remove("hidden")})).finally((()=>{this.isConfirmingEmpty=!1}))}catch(e){this.isConfirmingEmpty=!1}}},showFlashMessage:function(e,t="info"){let i=document.querySelector(".flash-message");switch(i?i.className="flash-message":(i=document.createElement("div"),i.className="flash-message",document.body.appendChild(i)),t){case"success":i.classList.add("bg-green-500","text-white");break;case"error":i.classList.add("bg-red-500","text-white");break;case"warning":i.classList.add("bg-yellow-500","text-white");break;default:i.classList.add("bg-blue-500","text-white")}i.textContent=e,setTimeout((()=>{i.classList.add("active")}),10),setTimeout((()=>{i.classList.remove("active")}),3e3)}};document.addEventListener("DOMContentLoaded",(function(){n.init()})),"undefined"!=typeof window&&(window.RecycleBinManager=n)}],t={};function i(n){var a=t[n];if(void 0!==a)return a.exports;var s=t[n]={exports:{}};return e[n](s,s.exports,i),s.exports}i.d=function(e,t){for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};!function(){i.r(n);var e=i(1),t=i(2),a=i(3),s=i(5),o=i(6),r=i(7),l=i(4),d=i(8),c=i(9);window.App={FileManager:a.FileManager,ThemeManager:e.ThemeManager,EditorManager:t.EditorManager,TagsManager:s.TagsManager,SearchManager:o.SearchManager,MediaManager:r.MediaManager,FieldManager:l.FieldManager,mainImageManager:d.mainImageManager,RecycleBinManager:c.RecycleBinManager},window.FileManager=a.FileManager,document.addEventListener("DOMContentLoaded",(function(){e.ThemeManager.init(),l.FieldManager.init(),t.EditorManager.init(),a.FileManager.init(),s.TagsManager.init(),o.SearchManager.init(),r.MediaManager.init(),d.mainImageManager.init(),c.RecycleBinManager.init(),function(){const e=document.querySelector(".new-file-btn");e&&e.addEventListener("click",(function(){l.FieldManager.handleNewFile()}));const i=document.querySelector(".save-btn");i&&i.addEventListener("click",(function(){l.FieldManager.collectCustomFieldValues()}));document.addEventListener("themeChanged",(function(e){t.EditorManager.updateEditorTheme&&t.EditorManager.updateEditorTheme(e.detail.theme)})),document.addEventListener("fileLoaded",(function(e){e.detail.content&&l.FieldManager.extractCustomFields(e.detail.content),e.detail.content&&s.TagsManager.extractTags(e.detail.content)})),document.addEventListener("cmsError",(function(e){console.error("CMS Error:",e.detail.message),alert("Error: "+e.detail.message)}))}(),function(){const e=new URLSearchParams(window.location.search).get("file");e&&setTimeout((()=>{a.FileManager.loadFile(e)}),100)}()}))}()}();
//# sourceMappingURL=scripts.js.map